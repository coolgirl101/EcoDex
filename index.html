<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EcoDex</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        :root { --primary: #2ecc71; --accent: #3498db; --bg: #f4f7f6; --font: -apple-system, sans-serif; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg); font-family: var(--font); overflow: hidden; height: 100vh; }

        /* START SKJERM */
        #startScreen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px;
        }
        .start-btn {
            background: var(--primary); color: white; padding: 20px 60px;
            border-radius: 50px; border: none; font-size: 20px; font-weight: 800;
            margin-top: 30px; box-shadow: 0 10px 30px rgba(46, 204, 113, 0.4);
            cursor: pointer; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }

        /* KART */
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* HUD */
        .top-hud {
            position: absolute; top: 0; left: 0; right: 0; 
            padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top));
            z-index: 1000; display: flex; flex-direction: column; align-items: center;
            background: linear-gradient(to bottom, rgba(255,255,255,0.9), transparent); pointer-events: none;
        }
        .hud-row { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); text-shadow: 2px 2px 0px white; }
        .score-badge {
            background: white; border: 2px solid var(--primary); border-radius: 20px;
            padding: 6px 16px; font-weight: bold; font-size: 16px; color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #debugStatus {
            font-size: 11px; color: #555; background: rgba(255,255,255,0.9);
            padding: 4px 10px; border-radius: 10px; margin-top: 5px; font-weight: bold;
            pointer-events: auto;
        }

        /* ROBOT "TOD ERIK" */
        .robot-wrapper {
            position: fixed; bottom: 140px; right: 20px; z-index: 2000;
            display: flex; flex-direction: column; align-items: flex-end; pointer-events: none;
        }
        .robot-bubble {
            background: white; padding: 12px; border-radius: 15px 15px 0 15px;
            font-size: 13px; margin-bottom: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 180px; text-align: right; display: none; font-weight: bold;
        }
        .robot-body {
            font-size: 60px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            animation: bounce 3s infinite ease-in-out; cursor: pointer; pointer-events: auto;
        }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-15px);} }

        /* KAMERA */
        #cameraPage { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: black; z-index: 6000; display: none; }
        #cameraPage.active { display: block; }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        #scanCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }
        #photoCanvas { display: none; }
        #capturedPhoto { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; display: none; z-index: 6001; }
        .qr-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; border: 3px solid var(--primary); border-radius: 10px; z-index: 6002; }
        .camera-ui {
            position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: center; z-index: 6005;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .snap-btn { width: 80px; height: 80px; background: white; border-radius: 50%; border: 6px solid #ddd; cursor: pointer; }
        .save-btn { background: var(--primary); color: white; padding: 15px 40px; border-radius: 30px; border: none; font-size: 18px; font-weight: bold; display: none; cursor: pointer; }
        .close-cam { position: absolute; top: 20px; right: 20px; color: white; font-size: 35px; top: max(20px, env(safe-area-inset-top)); z-index: 7000; cursor: pointer; }

        /* MENY */
        .bottom-nav {
            position: fixed; bottom: 25px; bottom: max(25px, env(safe-area-inset-bottom));
            left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; height: 70px;
            background: white; border-radius: 25px; display: flex; justify-content: space-between; align-items: center;
            z-index: 5000; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 0 15px;
        }
        .nav-group { display: flex; gap: 15px; width: 40%; justify-content: space-around; }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #bdc3c7; width: 50px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { width: 24px; height: 24px; fill: currentColor; }
        .nav-text { font-size: 10px; font-weight: 700; margin-top: 4px; text-transform: uppercase; }
        .cam-outer { position: absolute; left: 50%; top: -35px; transform: translateX(-50%); z-index: 5001; }
        .cam-btn-round {
            width: 75px; height: 75px; border-radius: 50%; background: var(--primary); border: 5px solid white;
            display: flex; justify-content: center; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); cursor: pointer;
        }
        .cam-btn-round svg { fill: white; width: 32px; height: 32px; }

        /* SIDER */
        .page { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fa; z-index: 4000; display: none; flex-direction: column; padding: 90px 20px 110px 20px; overflow-y: auto; }
        .page.active { display: flex; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .shop-item { background: white; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .buy-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 10px; border-radius: 10px; margin-top: 10px; font-weight: bold; cursor: pointer; }
        .me-dot { width: 20px; height: 20px; background: #3498db; border: 4px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1 style="color:#2c3e50; font-size: 40px; margin-bottom: 5px;">EcoDex</h1>
        <p style="color:#7f8c8d;">Utforsk verden!</p>
        <button class="start-btn" onclick="initGame()">START üìç</button>
        <p style="font-size: 13px; margin-top: 30px; color: #999; max-width: 80%;">
            Trykk "Tillat" for GPS. <br>Hvis det feiler, f√•r du velge posisjon selv.
        </p>
    </div>

    <div id="map"></div>

    <div class="top-hud">
        <div class="hud-row">
            <div class="logo">ECODEX</div>
            <div class="score-badge">‚≠ê <span id="scoreVal">0</span></div>
        </div>
        <div id="debugStatus">Klar til start...</div>
    </div>

    <div class="robot-wrapper" onclick="robotTalk()">
        <div class="robot-bubble" id="robotMsg">Hei! Jeg er Tod Erik.</div>
        <div class="robot-body">ü§ñ</div>
    </div>

    <div id="cameraPage">
        <div class="close-cam" onclick="closeCamera()">‚úï</div>
        <video id="videoFeed" autoplay playsinline muted></video>
        <canvas id="scanCanvas"></canvas>
        <div class="qr-overlay"></div>
        <canvas id="photoCanvas"></canvas>
        <img id="capturedPhoto" src="">
        <div class="camera-ui">
            <button class="snap-btn" id="snapBtn" onclick="takePhoto()"></button>
            <button class="save-btn" id="saveBtn" onclick="savePhotoAndGetPoints()">LAGRE (+100)</button>
        </div>
    </div>

    <div id="shopPage" class="page"><h2 style="text-align: center;">Butikk</h2><div id="shopList" class="shop-grid"></div></div>
    <div id="profilePage" class="page"><h2 style="text-align: center;">Galleri</h2><div id="gallery" class="shop-grid"></div><p id="emptyMsg" style="text-align: center;">Ingen bilder.</p></div>
    <div id="infoPage" class="page"><h2 style="text-align: center;">Info</h2><p style="text-align:center;">EcoDex v2.0 - Laget med kj√¶rlighet.</p></div>

    <div class="bottom-nav">
        <div class="nav-group">
            <button class="nav-item active" id="btnMap" onclick="showPage('map')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M20.5 3l-6 2-6-2-6 2v15l6 2 6-2 6 2 2.5-0.8V4.2L20.5 3zM14 17.5l-6 2-6-2V5.5l6 2 6-2v12z"/></svg><span class="nav-text">KART</span></button>
            <button class="nav-item" id="btnShop" onclick="showPage('shop')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg><span class="nav-text">BUTIKK</span></button>
        </div>
        <div class="cam-outer"><div class="cam-btn-round" onclick="openCamera()"><svg viewBox="0 0 24 24"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm6 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5-5 5z"/></svg></div></div>
        <div class="nav-group">
            <button class="nav-item" id="btnProfile" onclick="showPage('profile')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span class="nav-text">PROFIL</span></button>
            <button class="nav-item" id="btnInfo" onclick="showPage('info')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg><span class="nav-text">INFO</span></button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, playerMarker;
        let score = 0;
        let inventory = [];
        let manualLocationMode = false;
        let currentLat = 0, currentLng = 0;
        let gpsWatchId = null;
        let qrScanning = false;

        const shopItems = [
            {id: 1, name: "Hatt", cost: 150, icon: "üß¢"},
            {id: 2, name: "Sekk", cost: 300, icon: "üéí"},
            {id: 3, name: "Drone", cost: 500, icon: "üöÅ"},
            {id: 4, name: "Lys", cost: 100, icon: "üî¶"}
        ];

        function initGame() {
            document.getElementById('startScreen').style.display = 'none';
            loadData();
            setupMap();
            
            updateStatus("S√∏ker etter satellitter... (Vent 5 sek)");
            
            map.locate({setView: true, maxZoom: 18, timeout: 30000, enableHighAccuracy: true});
            startContinuousGPS();
            renderShop();
        }

        function startContinuousGPS() {
            if(navigator.geolocation) {
                gpsWatchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        currentLat = pos.coords.latitude;
                        currentLng = pos.coords.longitude;
                        playerMarker.setLatLng([currentLat, currentLng]);
                        updateStatus("üìç " + currentLat.toFixed(4) + ", " + currentLng.toFixed(4));
                    },
                    (err) => console.warn("GPS Watch Error:", err),
                    {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
                );
            }
        }

        function updateStatus(msg) {
            document.getElementById('debugStatus').innerText = msg;
        }

        function setupMap() {
            map = L.map('map', {zoomControl: false}).setView([0,0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '', maxZoom: 19 }).addTo(map);
            const icon = L.divIcon({className: 'p-icon', html: '<div class="me-dot"></div>', iconSize:[20,20]});
            playerMarker = L.marker([0,0], {icon: icon}).addTo(map);

            map.on('locationfound', onLocationFound);
            map.on('locationerror', onLocationError);
            
            map.on('click', function(e) {
                if(manualLocationMode) {
                    currentLat = e.latlng.lat;
                    currentLng = e.latlng.lng;
                    playerMarker.setLatLng(e.latlng);
                    map.setView(e.latlng, 17);
                    updateStatus("Manuell posisjon satt!");
                    robotTalk("Der er du! Vi kan spille.");
                    spawnCreature(e.latlng.lat + 0.0003, e.latlng.lng + 0.0003);
                    manualLocationMode = false;
                }
            });
        }

        function onLocationFound(e) {
            currentLat = e.latlng.lat;
            currentLng = e.latlng.lng;
            updateStatus("üìç " + currentLat.toFixed(4) + ", " + currentLng.toFixed(4));
            playerMarker.setLatLng(e.latlng);
            if(Math.random() > 0.8) spawnCreature(e.latlng.lat + 0.0005, e.latlng.lng + 0.0005);
        }

        function onLocationError(e) {
            console.warn(e);
            manualLocationMode = true;
            updateStatus("GPS Feilet. KLIKK p√• kartet for √• starte!");
            robotTalk("Jeg finner deg ikke. Klikk p√• kartet der du er!");
            alert("GPS feilet (Timeout). Klikk p√• kartet for √• sette din posisjon manuelt.");
        }

        function spawnCreature(lat, lng) {
            const icon = L.divIcon({html: '<div style="font-size:35px">ü¶â</div>', className:'c', iconSize:[35,35]});
            L.marker([lat, lng], {icon: icon}).addTo(map).bindPopup("En ugle!");
            robotTalk("Jeg ser et dyr!");
        }

        // --- KAMERA & QR SCANNING ---
        function openCamera() {
            document.getElementById('cameraPage').classList.add('active');
            document.getElementById('capturedPhoto').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('snapBtn').style.display = 'block';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => { 
                document.getElementById('videoFeed').srcObject = stream;
                qrScanning = true;
                scanQRCodes();
            })
            .catch(err => alert("Kamera Feil: " + err));
        }

        function closeCamera() {
            const vid = document.getElementById('videoFeed');
            if(vid.srcObject) vid.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('cameraPage').classList.remove('active');
            qrScanning = false;
        }

        function scanQRCodes() {
            if(!qrScanning) return;
            const vid = document.getElementById('videoFeed');
            const canvas = document.getElementById('scanCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = vid.videoWidth;
            canvas.height = vid.videoHeight;
            
            ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);
            
            if(code) {
                robotTalk("QR kod funnet! +250p");
                score += 250;
                saveData();
                updateScoreUI();
                qrScanning = false;
                setTimeout(() => closeCamera(), 1500);
            } else {
                requestAnimationFrame(scanQRCodes);
            }
        }

        function takePhoto() {
            qrScanning = false;
            const vid = document.getElementById('videoFeed');
            const can = document.getElementById('photoCanvas');
            const img = document.getElementById('capturedPhoto');
            can.width = vid.videoWidth; can.height = vid.videoHeight;
            can.getContext('2d').drawImage(vid, 0, 0);
            img.src = can.toDataURL('image/png');
            img.style.display = 'block';
            document.getElementById('snapBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'block';
        }

        function savePhotoAndGetPoints() {
            score += 100;
            saveData();
            updateScoreUI();
            const src = document.getElementById('capturedPhoto').src;
            const el = document.createElement('img');
            el.src = src; el.style.width='100%'; el.style.borderRadius='10px';
            document.getElementById('gallery').appendChild(el);
            document.getElementById('emptyMsg').style.display = 'none';
            robotTalk("Bilde lagret! +100p");
            closeCamera();
        }

        // ...existing code...
        function loadData() {
            const s = localStorage.getItem('ecoDexScore');
            const i = localStorage.getItem('ecoDexInv');
            if(s) score = parseInt(s);
            if(i) inventory = JSON.parse(i);
            updateScoreUI();
        }
        function saveData() { localStorage.setItem('ecoDexScore', score); localStorage.setItem('ecoDexInv', JSON.stringify(inventory)); }
        function updateScoreUI() { document.getElementById('scoreVal').innerText = score; }
        
        function renderShop() {
            const g = document.getElementById('shopList'); g.innerHTML = "";
            shopItems.forEach(i => {
                const owned = inventory.includes(i.id);
                g.innerHTML += `<div class="shop-item"><div style="font-size:35px">${i.icon}</div><b>${i.name}</b><br><span style="color:#2ecc71">${i.cost} p</span><br><button class="buy-btn ${owned?'owned':''}" onclick="buyItem(${i.id},${i.cost})">${owned?'EID':'KJ√òP'}</button></div>`;
            });
        }
        function buyItem(id, cost) {
            if(inventory.includes(id)) return;
            if(score >= cost) { score -= cost; inventory.push(id); saveData(); updateScoreUI(); renderShop(); robotTalk("Kj√∏pt!"); } 
            else robotTalk("Mangler poeng!");
        }
        
        function robotTalk(msg) {
            const b = document.getElementById('robotMsg'); b.innerText = msg; b.style.display = 'block';
            setTimeout(() => b.style.display = 'none', 4000);
        }
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            if(id === 'map') document.getElementById('btnMap').classList.add('active');
            if(id === 'shop') document.getElementById('btnShop').classList.add('active');
            if(id === 'profile') document.getElementById('btnProfile').classList.add('active');
            if(id === 'info') document.getElementById('btnInfo').classList.add('active');
            if(id !== 'map') document.getElementById(id+'Page').classList.add('active');
        }
    </script>
</body>
</html>